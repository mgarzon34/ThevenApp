package com.circuitos.AnalisisCircuitos.gui.learning.manager;

import java.util.HashSet;
import java.util.Optional;
import java.util.Set;

import com.circuitos.temporal.dominio.Circuito;
import com.circuitos.temporal.dominio.util.Unidades;
import com.circuitos.temporal.dominio.util.Unidades.Type;
import com.circuitos.temporal.gui.controller.PanelDisenoController;
import com.circuitos.temporal.gui.learning.database.LearningService;
import com.circuitos.temporal.gui.learning.manager.EjercicioSolver.SolucionAuto;
import com.circuitos.temporal.gui.learning.model.Ejercicio;
import com.circuitos.temporal.gui.service.io.CircuitoSerializerService;
import com.circuitos.temporal.gui.util.UIHelper;

import javafx.application.Platform;
import javafx.beans.value.ChangeListener;
import javafx.event.EventHandler;
import javafx.geometry.Insets;
import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonBar.ButtonData;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.GridPane;
import javafx.util.Pair;

/**
 * Clase que gestiona la sección de creación de ejercicios del módulo de E-Learning.
 * 
 * @author Marco Antonio Garzón Palos
 * @version 1.0
 */
public class EjercicioSectionManager {
	
	private final LearningService service;
	private PanelDisenoController disenoController;
	
	//Referencias UI
	private final ListView<Ejercicio> lista;
	private final TextField txtTitulo, txtVth, txtRth, txtIn, txtRn;
	private final TextArea txtDesc;
	private final ComboBox<Integer> cbDiff;
	private final ComboBox<String> cbTipo, cbVth, cbRth, cbIn, cbRn;
	private final Label lblEstado;
	
	//Estado
	private Ejercicio ejSelec=null;
	private String jsonTmp="{}";
	private boolean autoCalc=false;
	private boolean alertaActiva=false;
	
	private int tempNodoA=-1;
	private int tempNodoB=-1;
	
	/**
	 * Constructor del gestor de ejercicios.
	 * 
	 * @param service					Servicio de aprendizaje ({@link LearningService})
	 * @param lista						Lista de ejercicios
	 * @param txtTitulo					Campo para el título del ejercicio
	 * @param txtDesc					Campo para descripción del ejercicio
	 * @param cbDiff					Selector de dificultad
	 * @param cbTipo					Selector de tipo de análisis
	 * @param lblEstado					Etiqueta de estado
	 * @param txtVth					Campo de valor de Vth
	 * @param cbVth						Selector de unidad de Vth
	 * @param txtRth					Campo de valor de Rth
	 * @param cbRth						Selector de unidad de Rth
	 * @param txtIn						Campo de valor de In
	 * @param cbIn						Selector de unidad de In
	 * @param txtRn						Campo de valor de Rn
	 * @param cbRn						Selector de unidad de Rn
	 */
	public EjercicioSectionManager(LearningService service, ListView<Ejercicio> lista, TextField txtTitulo, 
								TextArea txtDesc, ComboBox<Integer> cbDiff, ComboBox<String> cbTipo,
								Label lblEstado, TextField txtVth, ComboBox<String> cbVth, TextField txtRth, 
								ComboBox<String> cbRth, TextField txtIn, ComboBox<String> cbIn,
								TextField txtRn, ComboBox<String> cbRn) {
		this.service=service;
		this.lista=lista;
		this.txtTitulo=txtTitulo;
		this.txtDesc=txtDesc;
		this.cbDiff=cbDiff;
		this.cbTipo=cbTipo;
		this.lblEstado=lblEstado;
		this.txtVth=txtVth; this.cbVth=cbVth;
		this.txtRth=txtRth; this.cbRth=cbRth;
		this.txtIn=txtIn; this.cbIn=cbIn;
		this.txtRn=txtRn; this.cbRn=cbRn;
		inicializar();
	}
	
	/**
	 * Establece el controlador del panel de diseño para importar el ejercicio.
	 * 
	 * @param c				Controlador del panel de diseño
	 */
	public void setPanelDisenoController(PanelDisenoController c) {
		this.disenoController=c;
	}
	
	/**
	 * Inicializa la sección.
	 */
	private void inicializar() {
		UIHelper.configurarLista(lista, e -> e.getTitulo()+" (Dif: "+e.getDificultad()+")");
		lista.getSelectionModel().selectedItemProperty().addListener((_, _, nv) -> cargarEditor(nv));
		configurarCombosUnidades();
		configurarProteccion();
		if(cbDiff!=null) {
			cbDiff.getItems().setAll(1, 2, 3, 4, 5);
			cbDiff.getSelectionModel().selectFirst();
		}
		if(cbTipo!=null) {
			cbTipo.getItems().setAll("THEVENIN", "NORTON", "AMBOS");
			cbTipo.getSelectionModel().select("AMBOS");
		}
	}
	
	/**
	 * Configura los combos de unidades según la magnitud que deben representar.
	 */
	private void configurarCombosUnidades() {
		if(cbVth!=null) { 
			cbVth.getItems().addAll("V", "kV", "mV");
			cbVth.getSelectionModel().selectFirst();
		}
		if(cbRth!=null) { 
			cbRth.getItems().addAll("Ω", "kΩ", "MΩ");
			cbRth.getSelectionModel().selectFirst();
		}
		if(cbIn!=null) { 
			cbIn.getItems().addAll("A", "mA");
			cbIn.getSelectionModel().selectFirst();
		}
		if(cbRn!=null) { 
			cbRn.getItems().addAll("Ω", "kΩ", "MΩ");
			cbRn.getSelectionModel().selectFirst();
		}
	}
	
	/**
	 * Carga la lista de ejercicios subidos por el profesor.
	 */
	public void cargarLista() {
		if(lista!=null) lista.getItems().setAll(service.getEjercicios());
	}
	
	/**
	 * Crea un ejercicio nuevo.
	 */
	public void nuevo() {
		ejSelec=null;
		lista.getSelectionModel().clearSelection();
		txtTitulo.clear(); txtDesc.clear();
		txtVth.clear(); txtRth.clear(); txtIn.clear(); txtRn.clear();
		jsonTmp="{}";
		lblEstado.setText("No hay circuito cargado");
		lblEstado.setStyle("-fx-text-fill: gray;");
		tempNodoA=-1; tempNodoB=-1;
	}
	
	/**
	 * Guarda la edición del ejercicio actual.
	 */
	public void guardar() {
		if(txtTitulo.getText().isEmpty()) UIHelper.mostrarError("Título obligatorio");
		Ejercicio ej=(ejSelec!=null) ? ejSelec : new Ejercicio();
		ej.setTitulo(txtTitulo.getText());
		ej.setDescripcion(txtDesc.getText());
		ej.setDificultad(cbDiff.getValue()!=null ? cbDiff.getValue() : 1);
		ej.setTipoAnalisis(cbTipo.getValue()!=null ? cbTipo.getValue() : "AMBOS");
		ej.setDatosCircuito(jsonTmp);
		
		ej.setSolucionVth(leerValor(txtVth, cbVth));
		ej.setSolucionRth(leerValor(txtRth, cbRth));
		ej.setSolucionIn(leerValor(txtIn, cbIn));
		ej.setSolucionRn(leerValor(txtRn, cbRn));
		
		ej.setNodoAnalisisA(tempNodoA);
		ej.setNodoAnalisisB(tempNodoB);
		
		if(service.guardarEjercicio(ej)) {
			UIHelper.mostrarInfo("Ejercicio guardado.");
			cargarLista();
			nuevo();
		}
	}
	
	/**
	 * Elimina un ejercicio de la lista de ejercicios.
	 */
	public void eliminar() {
		Ejercicio e=lista.getSelectionModel().getSelectedItem();
		if(e==null) return;
		if(UIHelper.mostrarConfirmacion("Borrar Ejercicio", "¿Seguro que quieres borrar "+e.getTitulo()+"?")) {
			service.eliminarEjercicio(e.getId());
			cargarLista();
			nuevo();
		}
	}
	
	/**
	 * Importa el circuito diseñado en el panel de diseño guardándolo en un archivo JSON temporal
	 * y llamando al analizador para que lo resuelva y poder rellenar los valores automáticamente.
	 */
	public void importarCircuito() {
		if(disenoController==null) return;
		var c=disenoController.getCircuitoActual();
		if(c==null || c.getComponentes().isEmpty()) {
			UIHelper.mostrarError("Diseño vacío.");
			return;
		}
		try {
			jsonTmp=new CircuitoSerializerService().serializar(c,  disenoController.getZonaDibujo());
			var sol=EjercicioSolver.resolverAuto(c);
			aplicarSolucion(sol);
			tempNodoA=-1; tempNodoB=-1;
			lblEstado.setText("Circuito importado y resuelto ✅");
			lblEstado.setStyle("-fx-text-fill: green; -fx-font-weight: bold;");
		} catch(Exception e) {
			boolean exitoManual=gestionarResolucionManual(c);
			if(!exitoManual) {
				UIHelper.mostrarError("Error: "+e.getMessage());
				autoCalc=false;
			}
		}
	}
	
	/**
	 * Gestiona la resolución manual de ejercicios (cuando no hay cargas) mostrando
	 * un diálogo para indicar los nodos de análisis.
	 * 
	 * @param c			Circuito a resolver
	 * @return {@code true} si se resolvió, {@code false} si no
	 */
	private boolean gestionarResolucionManual(Circuito c) {
		Set<Integer> nodos=new HashSet<>();
		c.getComponentes().forEach(comp -> {
			if(comp.getNodo1()>=0) nodos.add(comp.getNodo1());
			if(comp.getNodo2()>=0) nodos.add(comp.getNodo2());
		});
		if(nodos.size()<2) return false;
		Optional<Pair<Integer, Integer>> seleccion=mostrarDialogoNodos(nodos);
		if(seleccion.isPresent()) {
			int nA=seleccion.get().getKey();
			int nB=seleccion.get().getValue();
			try {
				var sol=EjercicioSolver.resolverManual(c, nA, nB);
				aplicarSolucion(sol);
				tempNodoA=nA;
				tempNodoB=nB;
				lblEstado.setText("Circuito importado (Nodos "+nA+"-"+nB+") ✅");
				lblEstado.setStyle("-fx-text-fill: darkgreen; -fx-font-weight: bold;");
				return true;
			} catch(Exception ex) {
				UIHelper.mostrarError("Error cálculo manual: "+ex.getMessage());
			}
		}
		return false;
	}
	
	/**
	 * Aplica la solución a los boxes de cada parámetro de análisis Thevenin y Norton.
	 * 
	 * @param sol			Paquete de soluciones
	 */
	private void aplicarSolucion(SolucionAuto sol) {
		setValor(txtVth, cbVth, sol.vth(), Type.TENSION);
		setValor(txtRth, cbRth, sol.rth(), Type.RESISTENCIA);
		setValor(txtIn, cbIn, sol.in(), Type.CORRIENTE);
		setValor(txtRn, cbRn, sol.rn(), Type.RESISTENCIA);
		autoCalc=true;
	}
	
	/**
	 * Muestra el diálogo para seleccionar dos nodos de análisis cuando no hay componente de carga.
	 * 
	 * @param nodos			Nodos de análisis
	 * @return Par de nodos
	 */
	private Optional<Pair<Integer, Integer>> mostrarDialogoNodos(Set<Integer> nodos) {
		Dialog<Pair<Integer, Integer>> dialog=new Dialog<>();
		dialog.setTitle("Selección manual de nodos");
		dialog.setHeaderText("No se ha detectado carga.\nSeleccione los nodos A y B para análisis:");
		ButtonType okType=new ButtonType("Calcular", ButtonData.OK_DONE);
		dialog.getDialogPane().getButtonTypes().addAll(okType, ButtonType.CANCEL);
		GridPane grid=new GridPane();
		grid.setHgap(10); grid.setVgap(10);
		grid.setPadding(new Insets(20, 10, 10, 10));
		ComboBox<Integer> cbA=new ComboBox<>();
		cbA.getItems().addAll(nodos);
		ComboBox<Integer> cbB=new ComboBox<>();
		cbB.getItems().addAll(nodos);
		grid.add(new Label("Nodo A:"), 0, 0); grid.add(cbA, 1, 0);
		grid.add(new Label("Nodo B:"), 0, 1); grid.add(cbB, 1, 1);
		dialog.getDialogPane().setContent(grid);
		Node okBtn=dialog.getDialogPane().lookupButton(okType);
		okBtn.setDisable(true); 
		ChangeListener<Integer> listener=(_, _, _) -> {
			boolean valido=cbA.getValue()!=null && cbB.getValue()!=null && !cbA.getValue().equals(cbB.getValue());
			okBtn.setDisable(!valido);
		};
		cbA.valueProperty().addListener(listener);
		cbB.valueProperty().addListener(listener);
		dialog.setResultConverter(btn -> {
			if(btn==okType) return new Pair<>(cbA.getValue(), cbB.getValue());
			return null;
		});
		return dialog.showAndWait();
	}
	
	/**
	 * Establece el valor y la unidad según el tipo de magnitud.
	 * 
	 * @param txt				Campo de texto donde se muestra el valor
	 * @param cb				ComboBox de unidades asociado al valor
	 * @param val				Valor numérico en unidades del SI
	 * @param tipo				Tipo de magnitud (tensión, resistencia, corriente)
	 */
	private void setValor(TextField txt, ComboBox<String> cb, double val, Type tipo) {
		String fmt=Unidades.format(val, tipo);
		String[] parts=fmt.split(" ");
		if(parts.length>=2) {
			txt.setText(parts[0]);
			String u=parts[1];
			if(cb.getItems().contains(u)) {
				cb.setValue(u);
			} else {
				cb.getSelectionModel().selectFirst();
				txt.setText(String.valueOf(val));
			}
		} else {
			txt.setText(String.valueOf(val));
			cb.getSelectionModel().selectFirst();
		}
	}
	
	/**
	 * Lee el valor de un campo numérico y lo convierte a unidades del SI según el prefijo
	 * del ComboBox asociado.
	 * 
	 * @param txt				Campo de texto con el valor numérico
	 * @param cb				ComboBox con la unidad seleccionada
	 * @return Valor en unidades del SI o 0.0 si hay error.
	 */
	private double leerValor(TextField txt, ComboBox<String> cb) {
		String s=txt.getText().replace(",", ".");
		if(s.isEmpty()) return 0.0;
		try {
			String u=cb.getValue();
			String pref=(u.length()>1) ? u.substring(0, u.length()-1) : "";
			return Unidades.parsear(s+pref);
		} catch(Exception e) {
			return 0.0;
		}
	}
	
	/**
	 * Carga los datos de un ejercicio en el editor para modificar.
	 * 
	 * @param e					Ejercicio a editar
	 */
	private void cargarEditor(Ejercicio e) {
		if(e==null) return;
		ejSelec=e;
		txtTitulo.setText(e.getTitulo());
		txtDesc.setText(e.getDescripcion());
		cbDiff.setValue(e.getDificultad());
		cbTipo.setValue(e.getTipoAnalisis());
		jsonTmp=e.getDatosCircuito();
		setValor(txtVth, cbVth, e.getSolucionVth(), Type.TENSION);
		setValor(txtRth, cbRth, e.getSolucionRth(), Type.RESISTENCIA);
		setValor(txtIn, cbIn, e.getSolucionIn(), Type.CORRIENTE);
		setValor(txtRn, cbRn, e.getSolucionRn(), Type.RESISTENCIA);
		tempNodoA=e.getNodoAnalisisA();
		tempNodoB=e.getNodoAnalisisB();
		if(e.tieneNodosManuales()) {
			lblEstado.setText("Cargado (Nodos manuales "+tempNodoA+"-"+tempNodoB+")");
		} else {
			lblEstado.setText("Cargado de base de datos");
		}
		lblEstado.setStyle("-fx-text-fill: blue;");
	}
	
	/**
	 * Configura la protección de edición sobre campos autocalculados.
	 * Al hacer click lanza una alerta de confirmación.
	 */
	private void configurarProteccion() {
		EventHandler<MouseEvent> handler=_ -> checkProteccion();
		txtVth.setOnMouseClicked(handler); txtRth.setOnMouseClicked(handler);
		txtIn.setOnMouseClicked(handler); txtRn.setOnMouseClicked(handler);
	}
	
	/**
	 * Comprueba si los valores autocalculados están protegidos para, en tal caso,
	 * pedir confirmación al usuario antes de editarlos.
	 */
	private void checkProteccion() {
		if(alertaActiva || !autoCalc) return;
		alertaActiva=true;
		Alert confirm=new Alert(Alert.AlertType.CONFIRMATION);
		confirm.setTitle("Modificación de valores");
		confirm.setHeaderText("Valores generados automáticamente");
		confirm.setContentText("Estos valores han sido autocalculados por la aplicación.\n"
				+"Esta acción no se puede deshacer y tendrá que volver a importar el circuito.\n"
				+"¿Seguro que quieres modificarlos?");
		Optional<ButtonType> result=confirm.showAndWait();
		if(result.orElse(ButtonType.CANCEL)==ButtonType.OK) {
			//Usuario quiere quitar protección
			autoCalc=false;
			lblEstado.setText("Valores editados manualmente ✏️");
			lblEstado.setStyle("-fx-text-fill: blue;");
		} else {
			lblEstado.requestFocus(); 	 //Si cancela quitamos el foco
		}
		Platform.runLater(() -> alertaActiva=false);
	}
}
